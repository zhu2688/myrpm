<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>File: TUNING [unicorn-4.8.3 Documentation]</title>

  <link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet" />

  <script src="./js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="./js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="./js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="./js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>
</head>

<body class="file">
  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="./index.html">Home</a>
          <a href="./index.html#classes">Classes</a>
          <a href="./index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="./Application_Timeouts.html">Application_Timeouts</a></li>
        
          <li class="file"><a href="./CONTRIBUTORS.html">CONTRIBUTORS</a></li>
        
          <li class="file"><a href="./ChangeLog.html">ChangeLog</a></li>
        
          <li class="file"><a href="./DESIGN.html">DESIGN</a></li>
        
          <li class="file"><a href="./FAQ.html">FAQ</a></li>
        
          <li class="file"><a href="./HACKING.html">HACKING</a></li>
        
          <li class="file"><a href="./ISSUES.html">ISSUES</a></li>
        
          <li class="file"><a href="./KNOWN_ISSUES.html">KNOWN_ISSUES</a></li>
        
          <li class="file"><a href="./LATEST.html">LATEST</a></li>
        
          <li class="file"><a href="./LICENSE.html">LICENSE</a></li>
        
          <li class="file"><a href="./Links.html">Links</a></li>
        
          <li class="file"><a href="./NEWS.html">NEWS</a></li>
        
          <li class="file"><a href="./PHILOSOPHY.html">PHILOSOPHY</a></li>
        
          <li class="file"><a href="./README.html">README</a></li>
        
          <li class="file"><a href="./SIGNALS.html">SIGNALS</a></li>
        
          <li class="file"><a href="./Sandbox.html">Sandbox</a></li>
        
          <li class="file"><a href="./TODO.html">TODO</a></li>
        
          <li class="file"><a href="./TUNING.html">TUNING</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class Index
          <span class="search-toggle"><img src="./images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="./Unicorn.html">Unicorn</a></li>
        
          <li><a href="./Unicorn/App.html">Unicorn::App</a></li>
        
          <li><a href="./Unicorn/App/OldRails.html">Unicorn::App::OldRails</a></li>
        
          <li><a href="./Unicorn/App/OldRails/Static.html">Unicorn::App::OldRails::Static</a></li>
        
          <li><a href="./Unicorn/CGIWrapper.html">Unicorn::CGIWrapper</a></li>
        
          <li><a href="./Unicorn/ClientShutdown.html">Unicorn::ClientShutdown</a></li>
        
          <li><a href="./Unicorn/Configurator.html">Unicorn::Configurator</a></li>
        
          <li><a href="./Unicorn/HttpParser.html">Unicorn::HttpParser</a></li>
        
          <li><a href="./Unicorn/HttpServer.html">Unicorn::HttpServer</a></li>
        
          <li><a href="./Unicorn/OobGC.html">Unicorn::OobGC</a></li>
        
          <li><a href="./Unicorn/PrereadInput.html">Unicorn::PrereadInput</a></li>
        
          <li><a href="./Unicorn/SSLClient.html">Unicorn::SSLClient</a></li>
        
          <li><a href="./Unicorn/SSLConfigurator.html">Unicorn::SSLConfigurator</a></li>
        
          <li><a href="./Unicorn/StreamInput.html">Unicorn::StreamInput</a></li>
        
          <li><a href="./Unicorn/TeeInput.html">Unicorn::TeeInput</a></li>
        
          <li><a href="./Unicorn/TmpIO.html">Unicorn::TmpIO</a></li>
        
          <li><a href="./Unicorn/Util.html">Unicorn::Util</a></li>
        
          <li><a href="./Unicorn/Worker.html">Unicorn::Worker</a></li>
        
          <li><a href="./ExecCgi/ExecCgi.html">ExecCgi::ExecCgi</a></li>
        
          <li><a href="./Inetd/Inetd.html">Inetd::Inetd</a></li>
        
          <li><a href="./Object.html">Object</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    
<h1>Tuning Unicorn</h1>

<p>Unicorn performance is generally as good as a (mostly) Ruby web server can
provide.  Most often the performance bottleneck is in the web application
running on <a href="Unicorn.html">Unicorn</a> rather than <a
href="Unicorn.html">Unicorn</a> itself.</p>

<h2>Unicorn Configuration</h2>

<p>See <a href="Unicorn/Configurator.html">Unicorn::Configurator</a> for
details on the config file format. <tt>worker_processes</tt> is the
most-commonly needed tuning parameter.</p>

<h3><a href="Unicorn/Configurator.html#method-i-worker_processes">Unicorn::Configurator#worker_processes</a></h3>
<ul><li>
<p>worker_processes should be scaled to the number of processes your backend
system(s) can support.  DO NOT scale it to the number of external network
clients your application expects to be serving. Unicorn is NOT for serving
slow clients, that is the job of nginx.</p>
</li><li>
<p>worker_processes should be <b>at</b> <b>least</b> the number of CPU cores
on a dedicated server.  If your application has occasionally slow responses
that are /not/ CPU-intensive, you may increase this to workaround those
inefficiencies.</p>
</li><li>
<p>worker_processes may be increased for <a
href="Unicorn/OobGC.html">Unicorn::OobGC</a> users to provide more
consistent response times.</p>
</li><li>
<p>Never, ever, increase worker_processes to the point where the system runs
out of physical memory and hits swap.  Production servers should never see
heavy swap activity.</p>
</li></ul>

<h3><a href="Unicorn/Configurator.html#method-i-listen">Unicorn::Configurator#listen</a> Options</h3>
<ul><li>
<p>Setting a very low value for the :backlog parameter in “listen” directives
can allow failover to happen more quickly if your cluster is configured for
it.</p>
</li><li>
<p>If you’re doing extremely simple benchmarks and getting connection errors
under high request rates, increasing your :backlog parameter above the
already-generous default of 1024 can help avoid connection errors.  Keep in
mind this is not recommended for real traffic if you have another machine
to failover to (see above).</p>
</li><li>
<p>:rcvbuf and :sndbuf parameters generally do not need to be set for TCP
listeners under Linux 2.6 because auto-tuning is enabled.  UNIX domain
sockets do not have auto-tuning buffer sizes; so increasing those will
allow syscalls and task switches to be saved for larger requests and
responses.  If your app only generates small responses or expects small
requests, you may shrink the buffer sizes to save memory, too.</p>
</li><li>
<p>Having socket buffers too large can also be detrimental or have little
effect.  Huge buffers can put more pressure on the allocator and may also
thrash CPU caches, cancelling out performance gains one would normally
expect.</p>
</li><li>
<p>UNIX domain sockets are slightly faster than TCP sockets, but only work if
nginx is on the same machine.</p>
</li></ul>

<h2>Other Unicorn settings</h2>
<ul><li>
<p>Setting “preload_app true” can allow copy-on-write-friendly GC to be used
to save memory.  It will probably not work out of the box with applications
that open sockets or perform random I/O on files. Databases like
TokyoCabinet use concurrency-safe pread()/pwrite() functions for safe
sharing of database file descriptors across processes.</p>
</li><li>
<p>On POSIX-compliant filesystems, it is safe for multiple threads or
processes to append to one log file as long as all the processes are have
them unbuffered (File#sync = true) or they are record(line)-buffered in
userspace before any writes.</p>
</li></ul>

<h2>Kernel Parameters (Linux sysctl)</h2>

<p>WARNING: Do not change system parameters unless you know what you’re doing!</p>
<ul><li>
<p>net.core.rmem_max and net.core.wmem_max can increase the allowed size of
:rcvbuf and :sndbuf respectively. This is mostly only useful for UNIX
domain sockets which do not have auto-tuning buffer sizes.</p>
</li><li>
<p>For load testing/benchmarking with UNIX domain sockets, you should consider
increasing net.core.somaxconn or else nginx will start failing to connect
under heavy load.  You may also consider setting a higher :backlog to
listen on as noted earlier.</p>
</li><li>
<p>If you’re running out of local ports, consider lowering
net.ipv4.tcp_fin_timeout to 20-30 (default: 60 seconds).  Also consider
widening the usable port range by changing net.ipv4.ip_local_port_range.</p>
</li><li>
<p>Setting net.ipv4.tcp_timestamps=1 will also allow setting
net.ipv4.tcp_tw_reuse=1 and net.ipv4.tcp_tw_recycle=1, which along with the
above settings can slow down port exhaustion.  Not all networks are
compatible with these settings, check with your friendly network
administrator before changing these.</p>
</li><li>
<p>Increasing the MTU size can reduce framing overhead for larger transfers. 
One often-overlooked detail is that the loopback device (usually “lo”) can
have its MTU increased, too.</p>
</li></ul>

  </div>

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>
</body>
</html>

